# ðŸ—ï¸ URSUS Architecture & Data Flow

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         URSUS Payment Gateway                            â”‚
â”‚                      (Stripe Connect Service)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              CUSTOMER PAYMENT FLOW
                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                                  ðŸ‘¤ CUSTOMER
                                      â”‚
                                      â”‚ Pays $100
                                      â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    URSUS Gateway        â”‚
                        â”‚  (app.py - Port 4242)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚
                    â†“                                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Creates PaymentIntentâ”‚        â”‚  Sends to            â”‚
        â”‚ on Platform Account  â”‚        â”‚  Platform Account    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ (Payment Success)
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Stripe Webhook      â”‚
        â”‚  charge.succeeded    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  URSUS Webhook      â”‚
        â”‚  Handler            â”‚
        â”‚  (/webhook)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Calculate Fees:     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ - Stripe Fee: 2.9%  â”‚
        â”‚ - Platform: 1%      â”‚
        â”‚ - Vendor: remainder â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Create Transfer to          â”‚
        â”‚  Connected Account           â”‚
        â”‚  (Vendor's Stripe Account)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ðŸ’° Vendor Receives Payment â”‚
        â”‚  in Connected Account       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## ðŸ›ï¸ Three Stripe Accounts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STRIPE ECOSYSTEM                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   YOU (Platform)     â”‚         â”‚  CUSTOMER            â”‚                â”‚
â”‚  â”‚                      â”‚         â”‚                      â”‚                â”‚
â”‚  â”‚ Platform Account     â”‚         â”‚ Pays for goods/      â”‚                â”‚
â”‚  â”‚ (sk_live_xxx)        â”‚         â”‚ services via Stripe  â”‚                â”‚
â”‚  â”‚                      â”‚         â”‚                      â”‚                â”‚
â”‚  â”‚ Receives: $100       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Card: **** 4242      â”‚                â”‚
â”‚  â”‚ Keeps: $0.97 + $3.20 â”‚ Webhook â”‚                      â”‚                â”‚
â”‚  â”‚ (commission + fees)  â”‚ Event   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚             â”‚                                                             â”‚
â”‚             â”‚ Automatic Transfer                                         â”‚
â”‚             â”‚ $95.83                                                      â”‚
â”‚             â”‚                                                             â”‚
â”‚             â†“                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚   YOUR VENDOR        â”‚                                                â”‚
â”‚  â”‚                      â”‚                                                â”‚
â”‚  â”‚ Connected Account    â”‚                                                â”‚
â”‚  â”‚ (acct_xxxx)          â”‚                                                â”‚
â”‚  â”‚                      â”‚                                                â”‚
â”‚  â”‚ Receives: $95.83 âœ“   â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”Œ API Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    URSUS API ENDPOINTS (app.py)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ POST /create-payment-intent                                            â”‚
â”‚ â”œâ”€ Purpose: Create a payment on your Platform Account                 â”‚
â”‚ â”œâ”€ Auth: X-API-Key header required                                    â”‚
â”‚ â”œâ”€ Limit: 10 per minute                                              â”‚
â”‚ â”œâ”€ Request:  { "amount": 10000, "order_id": "ORD-123" }             â”‚
â”‚ â””â”€ Response: { "client_secret": "...", "payment_intent_id": "..." } â”‚
â”‚                                                                         â”‚
â”‚ POST /webhook                                                          â”‚
â”‚ â”œâ”€ Purpose: Receive Stripe webhook events                             â”‚
â”‚ â”œâ”€ Auth: Stripe signature verification (whsec_...)                   â”‚
â”‚ â”œâ”€ Limit: 1000 per hour                                              â”‚
â”‚ â”œâ”€ Events: charge.succeeded, charge.captured, charge.refunded       â”‚
â”‚ â””â”€ Response: OK (200) or error                                        â”‚
â”‚                                                                         â”‚
â”‚ GET /health                                                            â”‚
â”‚ â”œâ”€ Purpose: Health check endpoint                                     â”‚
â”‚ â”œâ”€ Auth: None                                                         â”‚
â”‚ â”œâ”€ Limit: 200 per hour (default)                                     â”‚
â”‚ â””â”€ Response: { "status": "healthy", "stripe_connected": true }       â”‚
â”‚                                                                         â”‚
â”‚ GET /                                                                  â”‚
â”‚ â”œâ”€ Purpose: Root endpoint                                             â”‚
â”‚ â””â”€ Response: 404 (hidden for security)                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‹ Configuration Manager

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Configuration App (config_app.py)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  PORT 5000: Web Interface (templates/index.html)                   â”‚
â”‚                                                                      â”‚
â”‚  User Flow:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Web Form    â”‚â”€â”€â”€â”€â”€â–¶â”‚  Validation     â”‚â”€â”€â”€â”€â”€â–¶â”‚  Save to .envâ”‚   â”‚
â”‚  â”‚              â”‚      â”‚  - sk_live_     â”‚      â”‚  - Encrypted â”‚   â”‚
â”‚  â”‚ â€¢ Stripe Key â”‚      â”‚  - acct_        â”‚      â”‚  - Validated â”‚   â”‚
â”‚  â”‚ â€¢ Account ID â”‚      â”‚  - whsec_       â”‚      â”‚              â”‚   â”‚
â”‚  â”‚ â€¢ Webhook    â”‚      â”‚                 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚           â”‚
â”‚                                                          â”‚           â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚
â”‚                                      â”‚  /home/ursus/ursus/.env â”‚   â”‚
â”‚                                      â”‚  (Persistent Storage)   â”‚   â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” Security Features

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SECURITY LAYERS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ 1ï¸âƒ£  API Authentication                                             â”‚
â”‚    â”œâ”€ X-API-Key header validation                                 â”‚
â”‚    â”œâ”€ Key rotation support                                        â”‚
â”‚    â””â”€ Logs invalid attempts                                       â”‚
â”‚                                                                      â”‚
â”‚ 2ï¸âƒ£  Webhook Verification                                          â”‚
â”‚    â”œâ”€ Stripe signature check (whsec_...)                          â”‚
â”‚    â”œâ”€ Timestamp validation                                        â”‚
â”‚    â””â”€ Rejects unsigned requests                                   â”‚
â”‚                                                                      â”‚
â”‚ 3ï¸âƒ£  Rate Limiting                                                  â”‚
â”‚    â”œâ”€ 10/minute per IP for /create-payment-intent               â”‚
â”‚    â”œâ”€ 1000/hour per IP for /webhook                             â”‚
â”‚    â””â”€ 200/hour default for other endpoints                       â”‚
â”‚                                                                      â”‚
â”‚ 4ï¸âƒ£  Input Validation                                              â”‚
â”‚    â”œâ”€ Amount range checks ($0.50 - $999,999.99)                 â”‚
â”‚    â”œâ”€ Email format validation                                    â”‚
â”‚    â”œâ”€ String length limits                                       â”‚
â”‚    â””â”€ Alphanumeric sanitization                                  â”‚
â”‚                                                                      â”‚
â”‚ 5ï¸âƒ£  Idempotency Protection                                        â”‚
â”‚    â”œâ”€ Processed charges tracked in memory                        â”‚
â”‚    â”œâ”€ Prevents duplicate transfers                               â”‚
â”‚    â”œâ”€ Idempotency keys on all transfers                         â”‚
â”‚    â””â”€ Production: Use Redis for distributed systems             â”‚
â”‚                                                                      â”‚
â”‚ 6ï¸âƒ£  Error Handling                                                â”‚
â”‚    â”œâ”€ Secure error messages (no stack traces)                   â”‚
â”‚    â”œâ”€ Logging of suspicious activity                            â”‚
â”‚    â”œâ”€ Fail2Ban integration for brute force                      â”‚
â”‚    â””â”€ 500 errors don't leak information                         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ’° Fee Calculation Breakdown

```
Customer Payment: $100.00
    â”‚
    â”œâ”€ Step 1: Calculate Stripe Fees
    â”‚  â””â”€ Stripe charges: (100 Ã— 0.029) + $0.30 = $3.20
    â”‚
    â”œâ”€ Step 2: Calculate Net After Stripe
    â”‚  â””â”€ $100.00 - $3.20 = $96.80
    â”‚
    â”œâ”€ Step 3: Calculate Platform Commission (1% of net)
    â”‚  â””â”€ $96.80 Ã— 0.01 = $0.97 (Platform keeps this)
    â”‚
    â””â”€ Step 4: Calculate Vendor Transfer
       â””â”€ $96.80 - $0.97 = $95.83 (Vendor receives this)

    VERIFICATION: $3.20 + $0.97 + $95.83 = $100.00 âœ“
```

---

## ðŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION DEPLOYMENT                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Internet â”€â”€â–¶ Nginx (Port 443 - HTTPS)                            â”‚
â”‚               â”œâ”€ SSL/TLS Certificate (Certbot)                     â”‚
â”‚               â”œâ”€ Reverse Proxy                                     â”‚
â”‚               â”œâ”€ Rate Limiting                                     â”‚
â”‚               â””â”€ Security Headers                                  â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚              Gunicorn (Port 4242)                                  â”‚
â”‚              â”œâ”€ 4 Workers                                          â”‚
â”‚              â”œâ”€ 2 Threads per Worker                               â”‚
â”‚              â”œâ”€ 30 second timeout                                  â”‚
â”‚              â””â”€ Auto-restart on failure                            â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â”œâ”€â–¶ app.py (URSUS Gateway)                  â”‚
â”‚                       â””â”€â–¶ config_app.py (Configuration)           â”‚
â”‚                                                                     â”‚
â”‚  Systemd Service (ursus.service)                                  â”‚
â”‚  â”œâ”€ Runs as 'ursus' user                                          â”‚
â”‚  â”œâ”€ Auto-restart on crash                                         â”‚
â”‚  â”œâ”€ Logging to /var/log/ursus/                                    â”‚
â”‚  â””â”€ Fail2Ban protection                                           â”‚
â”‚                                                                     â”‚
â”‚  Log Rotation                                                       â”‚
â”‚  â”œâ”€ Daily rotation                                                 â”‚
â”‚  â”œâ”€ 14-day retention                                              â”‚
â”‚  â””â”€ Compression enabled                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Data Storage & Persistence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PERSISTENT STORAGE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ /home/ursus/ursus/.env                                            â”‚
â”‚ â”œâ”€ STRIPE_SECRET_KEY                                              â”‚
â”‚ â”œâ”€ STRIPE_WEBHOOK_SECRET                                          â”‚
â”‚ â”œâ”€ CONNECTED_ACCOUNT_ID                                           â”‚
â”‚ â”œâ”€ URSUS_API_KEY                                                  â”‚
â”‚ â”œâ”€ PLATFORM_NAME                                                  â”‚
â”‚ â””â”€ CONNECTED_NAME                                                 â”‚
â”‚                                                                     â”‚
â”‚ /var/log/ursus/                                                   â”‚
â”‚ â”œâ”€ access.log (HTTP access logs)                                 â”‚
â”‚ â”œâ”€ error.log (Application errors)                                â”‚
â”‚ â””â”€ monitor.log (Health check results)                            â”‚
â”‚                                                                     â”‚
â”‚ In-Memory (Development/Single Server)                             â”‚
â”‚ â””â”€ processed_charges (set) - Prevents duplicate transfers        â”‚
â”‚                                                                     â”‚
â”‚ Recommended for Production:                                        â”‚
â”‚ â””â”€ Redis - Distributed idempotency across multiple servers       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Webhook Event Flow

```
STRIPE WEBHOOK EVENT
        â”‚
        â”œâ”€ Stripe sends to your endpoint
        â”œâ”€ URSUS verifies signature (whsec_...)
        â”‚
        â””â”€ Event Type Handling:
           â”‚
           â”œâ”€ charge.succeeded (MOST COMMON)
           â”‚  â””â”€ Transfer funds to Connected Account
           â”‚
           â”œâ”€ charge.captured (For manually captured payments)
           â”‚  â””â”€ Transfer funds to Connected Account
           â”‚
           â”œâ”€ charge.refunded
           â”‚  â””â”€ Log refund (Platform absorbs cost as MoR)
           â”‚
           â””â”€ Other events
              â””â”€ Logged but not processed
```

---

## ðŸ“ˆ Monitoring & Health Checks

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MONITORING SYSTEM                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ Health Endpoint: /health                                          â”‚
â”‚ â””â”€ Returns: Stripe connectivity status                           â”‚
â”‚                                                                     â”‚
â”‚ Fail2Ban Protection                                               â”‚
â”‚ â”œâ”€ Monitors: /var/log/ursus/error.log                           â”‚
â”‚ â”œâ”€ Pattern: "Invalid API key attempt"                           â”‚
â”‚ â””â”€ Action: Ban after 5 attempts for 1 hour                      â”‚
â”‚                                                                     â”‚
â”‚ Cron Monitoring (Every 5 minutes)                                â”‚
â”‚ â”œâ”€ Health check (HTTP 200?)                                     â”‚
â”‚ â”œâ”€ Disk usage (>80%?)                                           â”‚
â”‚ â”œâ”€ Memory usage (>90%?)                                         â”‚
â”‚ â””â”€ Auto-restart on failure                                      â”‚
â”‚                                                                     â”‚
â”‚ Logs Available                                                    â”‚
â”‚ â”œâ”€ Application logs: journalctl -u ursus -f                    â”‚
â”‚ â”œâ”€ Access logs: tail /var/log/ursus/access.log                â”‚
â”‚ â”œâ”€ Error logs: tail /var/log/ursus/error.log                  â”‚
â”‚ â””â”€ System logs: dmesg                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture ensures:
- âœ… **Security**: Multi-layer protection
- âœ… **Reliability**: Auto-restart & monitoring
- âœ… **Scalability**: Ready for Redis & multiple servers
- âœ… **Transparency**: Detailed logging & monitoring
- âœ… **Auditability**: All transactions tracked

